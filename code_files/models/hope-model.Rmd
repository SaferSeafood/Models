---
title: "Hope Model Stuff"
author: "Hope Hahn"
date: "2024-02-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Summary

## The Data

The data used in this project will be:

***Sediment Data***

The sediment .rds file contains the total DDT sediment concentration and year. 

***Fish Data***

Fish life history:
Fish life history data contains trophic and feeding position data for species that were sampled. 

Fish DDT data:
Fish DDT data contains total DDT concentration, lipid normalized DDT data, and other fish DDT information.

## Main Steps
***Client Code***
* Read in and tidy sediment and fish data
* Bayesian modeling

***My Code***
* testing regression with recipes and stuff

## Regress fish [DDT] against sediment [DDT]

```{r}
# install and/or load the necessary R packages
if("pacman" %in% installed.packages() == FALSE){install.packages("pacman")}
pacman::p_load(geojsonR, factoextra,sf,dplyr, ggplot2, maps, fields,raster, 
               MuMIn, lubridate, tidyr,ggh4x, lme4,sdmTMB,inlabru,cowplot,marmap,sjPlot, tidyverse, plyr, tidybayes, brms, bayesplot, loo,ggeffects,
               DHARMa)
#rgeos, INLAutils, DHARMa.helpers)
```

## Load in data and add censoring column

** In these steps, we will read in the data, and combine relevent data. We will add columns of transformed data and add censoring column.

*What is censoring column?*

```{r}
fish_reg <- read.csv(here::here("data", "data_outputs", "fish_clean.csv"))
```


## Some simple modeling 

To understand Bayesian modeling: https://www.r-bloggers.com/2019/05/bayesian-models-in-r-2/

## Run BRMS Models 

Run the models.

*What is the difference between the interactions (colon vs asterik)?*

# --------------------------------------------------------------------------------------------------------------
brm.habitat.slope = brm(TotalDDT.trans.non|cens(Censored, Detection.Limit) ~ TotalDDT.sed.trans + TotalDDT.sed.trans:feeding_position, 
data = fish_reg, 
prior = c(set_prior("cauchy(0, 0.5)", 
class = "b")))

brm.habitat.intercept = brm(TotalDDT.trans.non|cens(Censored, Detection.Limit) ~ TotalDDT.sed.trans + feeding_position, 
  data =  fish_reg, 
  prior = c(set_prior("cauchy(0, 0.5)", 
  class = "b")))

brm.diet.slope = brm(TotalDDT.trans.non|cens(Censored, Detection.Limit) ~ TotalDDT.sed.trans + TotalDDT.sed.trans:trophic_category, 
  data =fish_reg, 
  prior = c(set_prior("cauchy(0, 0.5)", 
  class = "b")))

brm.diet.intercept = brm(TotalDDT.trans.non|cens(Censored, Detection.Limit) ~ TotalDDT.sed.trans + trophic_category, 
  data =fish_reg, 
  prior = c(set_prior("cauchy(0, 0.5)", 
  class = "b")))

brm.trophic = brm(TotalDDT.trans.non|cens(Censored, Detection.Limit) ~ TotalDDT.sed.trans * trophic_category, 
  data =fish_reg, 
  prior = c(set_prior("cauchy(0, 0.5)", 
  class = "b")))

brm.habitat = brm(TotalDDT.trans.non|cens(Censored, Detection.Limit) ~ TotalDDT.sed.trans * feeding_position, 
  data =fish_reg, 
  prior = c(set_prior("cauchy(0, 0.5)", 
  class = "b")))

brm.diet.habitat = brm(TotalDDT.trans.non|cens(Censored, Detection.Limit) ~ TotalDDT.sed.trans * trophic_category + TotalDDT.sed.trans * feeding_position, 
  data =fish_reg, 
  prior = c(set_prior("cauchy(0, 0.5)", 
  class = "b")))

brm.diet.habitat.year = brm(TotalDDT.trans.non|cens(Censored, Detection.Limit) ~ TotalDDT.sed.trans * trophic_category + TotalDDT.sed.trans * feeding_position + Year, 
  data =fish_reg, 
  prior = c(set_prior("cauchy(0, 0.5)", 
  class = "b")))

brm.diet.habitat.species = brm(TotalDDT.trans.non|cens(Censored, Detection.Limit) ~ TotalDDT.sed.trans * trophic_category + TotalDDT.sed.trans * feeding_position  + (1|CompositeCommonName), 
  data =fish_reg, 
  prior = c(
  set_prior("cauchy(0, 0.5)", class = "b"),   
  set_prior("cauchy(0, 2)", class = "sd")))

brm.diet.habitat.species.year = brm(TotalDDT.trans.non|cens(Censored, Detection.Limit) ~ TotalDDT.sed.trans * trophic_category + TotalDDT.sed.trans * feeding_position + Year + (1|CompositeCommonName), 
  data =fish_reg, 
  prior = c(
  set_prior("cauchy(0, 0.5)", class = "b"),   
  set_prior("cauchy(0, 2)", class = "sd")))
# --------------------------------------------------------------------------------------------------------------

## Trying some stuff out

### Prep:
```{r}
library(tidyverse)
library(tidymodels)

# select only relevant columns
fish_cleaned <- fish_reg %>% 
  janitor::clean_names() %>% 
  dplyr::select(total_ddt_trans_non, total_ddt_sed_trans, trophic_category, feeding_position, composite_common_name, censored, detection_limit)

# ------------------------------------- this didnt work ------------------------------
# set formula
## dont know how this would work with bayesian modeling
#fish_formula <- brmsformula(total_ddt_trans_non|cens(censored, detection_limit) ~ #total_ddt_sed_trans * trophic_category + total_ddt_sed_trans * feeding_position  + #(1|composite_common_name)) 
# ------------------------------------------------------------------------------------

# split training and testing data
fish_split <- fish_cleaned %>% 
  initial_split(prop = 0.7)

fish_train <- training(fish_split)
fish_test <- testing(fish_split)

# are we supposed to put the correct formula in here?? bc it does not work when copy and pasting above thing
# try out recipe: 
fish_recipe <- recipe(total_ddt_trans_non ~ ., data = fish_train) %>% 
  step_integer(all_predictors(), zero_based = TRUE)

fish_prep <- prep(fish_recipe)

fish_baked <- bake(fish_prep, new_data = NULL)
```

# Training the model
```{r}
# set model specification
brm_fish_spec <- linear_reg() %>% 
  set_engine("stan", prior = c(
    set_prior("cauchy(0, 0.5)", class = "b"),   
    set_prior("cauchy(0, 2)", class = "sd"))) %>% 
  set_mode("regression")

# create workflow
brm_wf <- workflow() %>% 
  add_recipe(fish_recipe) %>% 
  add_model(brm_fish_spec) 

library('rstanarm')

# Train the model
brm_wf_fit <- brm_wf %>% 
  fit(data = fish_train) 

# make predictions
predictions <- brm_wf_fit %>% 
  predict(new_data = pumpkins_test)
```

## Creating a function to add species and location to output DDT concentration with model

* Create a function to predict DDT concentration for species?

```{r}

```
