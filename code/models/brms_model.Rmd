---
title: "brms modeling"
author: "Hope Hahn"
date: "2024-05-08"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(brms)
library(rfishbase)
```

**Load in Data**

```{r, message = FALSE}
# load in the cleaned data with transformed variables 
fish_clean <- read_csv(here::here("data", "data_outputs", "fish_clean.csv"))

# load in the life hsitory characteristics
fish_lh <- read_csv(here::here("data", "fish_data", "fish_life_history.csv"))

# load in data with family
fish.clean.fam <- read_csv(here::here("data", "data_outputs", "fish_clean_fam.csv"))
```

**The model**

```{r}
# model that is currently in the dashboard
brm.diet.habitat.year.fam.clean = brm(TotalDDT.trans.non|cens(Censored, Detection.Limit) ~ TotalDDT.sed.trans * trophic_category + TotalDDT.sed.trans * feeding_position + Year + (1|Family), 
                                      data =fish.clean.fam, 
                                      prior = c(set_prior("cauchy(0, 0.5)", class = "b"),
                                                set_prior("cauchy(0, 2)", class = "sd")) 
)
```

**Getting and plotting posterior range**

```{r}
# make new data frames ----
new_data <- data.frame(TotalDDT.sed.trans = 7.288251, # get from fishing zone
                       trophic_category = "Secondary Carnivore", # get from life history characteristics
                       feeding_position = "Benthopelagic", # get from life history characteristics
                       Family = "Sciaenidae",
                       Year = 2)

# predict posteriors
# using posterior predict for now
post_pred <- posterior_predict(brm.diet.habitat.year.fam.clean, newdata = new_data)

# create df of them
df_pred <- as.data.frame(post_pred) %>% 
  mutate(V1_non = exp(V1) - 1) 

# get the prediction point
#pred_point <- df_pred %>% 
  #summarize(mean = mean(V1_untransform))

# plot data
plt <- ggplot(df_pred, aes(x = V1_non)) +
  geom_histogram(aes(y = ..density..),
                 alpha = 0) +
  geom_density() + # bw for smoothing
  theme_classic() + 
  labs(x = "DDT Concentration (ng/g)",
       y = "Density") #+
  #theme(axis.line.y = element_blank(),
        #axis.text.y = element_blank(),
        #axis.ticks.y = element_blank()) #+
  #annotate("rect", xmin = 0, xmax = 250, ymin = 0, ymax = 0.0001, alpha = 0.2, fill = "green") +
  #annotate("rect", xmin=250, xmax=500, ymin=0, ymax=0.008, alpha=0.2, fill="yellow") +
  #annotate("rect", xmin=500, xmax=1000, ymin=0, ymax=0.000001, alpha=0.2, fill="red") 

plt
```

There will be a legend that describes what each color means (green is 7 servings a week, yellow is x servings a week, etc)
Some questions:

at what levels do we want to specify 


**Trying out the rectangle stuff**

```{r}
df <- data.frame()
ggplot()
```



